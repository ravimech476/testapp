#!/bin/bash

# Automobile Safety API - PM2 Deployment Script
echo "ğŸš€ Starting Automobile Safety API with PM2..."

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Navigate to project directory
cd /home/test/testapp

# Check if virtual environment exists
if [ ! -d "venv" ]; then
    echo -e "${RED}âŒ Virtual environment not found! Run deploy.sh first.${NC}"
    exit 1
fi

# Stop existing process if running
echo -e "${YELLOW}ğŸ›‘ Stopping existing PM2 process...${NC}"
pm2 delete automobile-safety-api 2>/dev/null || true

# Activate virtual environment and check dependencies
echo -e "${YELLOW}ğŸ“¦ Checking dependencies...${NC}"
source venv/bin/activate
pip list | grep -E "(fastapi|uvicorn|motor)" > /dev/null
if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Missing dependencies! Installing...${NC}"
    pip install -r requirements.txt
fi

# Create necessary directories
mkdir -p uploads logs

# Set environment variables (backup method)
export MONGO_URL="mongodb://yelmosatheesh:Reset%40123@93.127.134.137:27017?authSource=admin"
export DATABASE_NAME="autosafety"
export SECRET_KEY="automobile-safety-2024-super-secret-key"

# Start with PM2
echo -e "${YELLOW}ğŸš€ Starting with PM2...${NC}"
pm2 start ecosystem.config.js

# Check status
sleep 3
pm2 list

# Show logs briefly
echo -e "${YELLOW}ğŸ“‹ Recent logs:${NC}"
pm2 logs automobile-safety-api --lines 10

echo -e "${GREEN}âœ… Deployment complete!${NC}"
echo -e "${GREEN}ğŸŒ API should be available at: http://localhost:8000${NC}"
echo -e "${GREEN}ğŸ¥ Health check: http://localhost:8000/api/health${NC}"
echo -e "${GREEN}ğŸ“– API docs: http://localhost:8000/docs${NC}"
